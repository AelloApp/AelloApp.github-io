<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset your password</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0f0f0f; color:#fff; padding:24px; }
    .card { max-width:820px; margin:16px auto; background:#111; border-radius:10px; padding:24px; border:1px solid #2b2b2b; }
    label { display:block; margin:8px 0 6px; color:#cfcfcf; }
    input[type="password"]{ width:100%; padding:12px 14px; border-radius:8px; border:1px solid #333; background:#0b0b0b; color:#fff; }
    button { background:#C9A85C; border:0; color:#000; padding:12px 18px; font-weight:600; border-radius:22px; cursor:pointer; }
    button.secondary { background:#000; color:#C9A85C; border:1px solid #C9A85C; }
    .muted { color:#bdbdbd; font-size:0.95rem; }
    pre.debug { background:#090909; border:1px solid #222; padding:12px; color:#e6e6e6; white-space:pre-wrap; word-break:break-all; margin-top:12px; border-radius:8px; }
    .error { background:#600; color:#fff; padding:10px; border-radius:6px; margin-top:12px; }
    .ok { background:#083; color:#fff; padding:10px; border-radius:6px; margin-top:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1 style="color:#C9A85C; margin:0 0 8px">Reset your password</h1>
    <p class="muted">Enter a new password below. The page will use the recovery token from the URL.</p>

    <div id="tokenInfo" class="muted" style="margin:12px 0">Detecting token...</div>

    <label>New password</label>
    <input id="pw1" type="password" autocomplete="new-password" />

    <label>Confirm</label>
    <input id="pw2" type="password" autocomplete="new-password" />

    <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px;">
      <button class="secondary" id="cancelBtn">Cancel</button>
      <button id="submitBtn">Set new password</button>
    </div>

    <div id="result"></div>

    <h4 style="margin-top:18px">Debug</h4>
    <pre class="debug" id="debugBox">(network/debug info will appear here)</pre>
  </div>

<script>
(async function(){
  // ---------- CONFIG - replace these ----------
  const SUPABASE_URL = "https://rbyjwdvnfbdtavxwkqyx.supabase.co"; // <- replace
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJieWp3ZHZuZmJkdGF2eHdrcXl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NTQzNDAsImV4cCI6MjA4MzIzMDM0MH0.eV4lTewGYaxDcHqAbuR1yv3CgtlCOnPFIW5dCZsaAXE"; // <- replace with anon public key (not service_role)
  // --------------------------------------------

  function dbg(v){ document.getElementById('debugBox').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); }

  // Robust token extraction:
  // - check location.hash for "access_token=" (typical)
  // - check location.search for access_token key (some hosts put in query)
  // - if the page is loaded inside an iframe/embedded, attempt to read window.location.href fallback
  function extractToken() {
    const h = window.location.hash || "";
    const q = window.location.search || "";
    // parse hash '#access_token=...&...'
    if (h.includes("access_token=")) {
      const m = new URLSearchParams(h.replace(/^#/, ''));
      return m.get("access_token");
    }
    if (q.includes("access_token=")){
      const m = new URLSearchParams(q);
      return m.get("access_token");
    }
    // sometimes token appended as fragment id with 'token=' or 'access_token='
    // fallback: search the whole href
    const href = window.location.href || "";
    const tMatch = href.match(/[#?](?:.*&)?access_token=([^&]+)/);
    if (tMatch) return decodeURIComponent(tMatch[1]);
    return null;
  }

  const token = extractToken();
  document.getElementById('tokenInfo').textContent = token ? "Token detected (masked): " + token.slice(0,8) + "â€¦" : "No token found in URL. Open the link directly from the email.";

  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', ()=> { window.close?.(); });

  async function setPassword(newPassword){
    // call Supabase auth "update user" endpoint
    const url = `${SUPABASE_URL}/auth/v1/user`;
    const headers = {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token,
      "apikey": ANON_KEY
    };

    dbg({ url, headers: { Authorization: headers.Authorization, apikey: "REDACTED" } });

    // The body is { password: "..." }
    let resp;
    try {
      resp = await fetch(url, {
        method: "PATCH",
        headers,
        body: JSON.stringify({ password: newPassword })
      });
    } catch (fetchErr) {
      dbg("Network error: " + fetchErr);
      document.getElementById('result').innerHTML = `<div class="error">Network error: ${fetchErr}</div>`;
      return { ok:false, statusText: fetchErr.toString() };
    }

    const text = await resp.text();
    let body;
    try { body = JSON.parse(text); } catch (e) { body = text; }

    dbg({ status: resp.status, statusText: resp.statusText, body });

    if (resp.status >= 200 && resp.status < 300){
      document.getElementById('result').innerHTML = `<div class="ok">Password updated successfully.</div>`;
      return { ok:true, status:resp.status, body };
    } else {
      // show server error
      document.getElementById('result').innerHTML = `<div class="error">Failed to update password (status ${resp.status}). See debug box for details.</div>`;
      return { ok:false, status:resp.status, body };
    }
  }

  document.getElementById('submitBtn').addEventListener('click', async () => {
    document.getElementById('result').innerHTML = "";
    const p1 = document.getElementById('pw1').value || "";
    const p2 = document.getElementById('pw2').value || "";
    if (!token) {
      document.getElementById('result').innerHTML = `<div class="error">No token detected in URL. Use the link from your email.</div>`;
      return;
    }
    if (p1.length < 6) {
      document.getElementById('result').innerHTML = `<div class="error">Password must be >= 6 chars.</div>`;
      return;
    }
    if (p1 !== p2) {
      document.getElementById('result').innerHTML = `<div class="error">Passwords do not match.</div>`;
      return;
    }

    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = "Updating...";

    const res = await setPassword(p1);

    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').textContent = "Set new password";

    // If 401: print reasons and suggestions to debug
    if (!res.ok && res.status === 401) {
      // show extra advice
      document.getElementById('debugBox').textContent += "\n\nHint: 401 often means token invalid or missing Authorization header. Confirm the token and check the 'Authorization' header in Network panel.";
    }
  });

  // auto focus first field
  document.getElementById('pw1').focus();
})();
</script>
</body>
</html>
